name: Build Android APK (For Mid-term)
on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install NativeScript
        run: npm install -g nativescript@8.6.0 --ignore-scripts

      - name: Install Dependencies
        run: |
          npm install --legacy-peer-deps
          npx ts-patch install -s

      # ----------------------------------------------------------------
      # 手动填充原生依赖
      # ----------------------------------------------------------------
      - name: Download OpenCV
        run: |
          wget -q https://github.com/opencv/opencv/releases/download/4.5.5/opencv-4.5.5-android-sdk.zip
          unzip -q opencv-4.5.5-android-sdk.zip
          rm -rf plugin-nativeprocessor/platforms/android/cpp/opencv
          mkdir -p plugin-nativeprocessor/platforms/android/cpp/opencv
          cp -r OpenCV-android-sdk/sdk/native/* plugin-nativeprocessor/platforms/android/cpp/opencv/

      - name: Download Tesseract
        run: |
          wget -q https://github.com/tesseract-ocr/tesseract/archive/refs/tags/4.1.3.zip -O tesseract.zip
          unzip -q tesseract.zip
          rm -rf plugin-nativeprocessor/platforms/android/cpp/tesseract
          mkdir -p plugin-nativeprocessor/platforms/android/cpp/tesseract
          cp -r tesseract-4.1.3/* plugin-nativeprocessor/platforms/android/cpp/tesseract/

      # ----------------------------------------------------------------
      # 【完美修正】Kotlin 代码修复
      # ----------------------------------------------------------------
      - name: Perfect Kotlin Fix
        run: |
          FILE=$(find plugin-nativeprocessor -name "PDFUtils.kt")
          echo "Patching source file: $FILE"
          sed -i '1i @file:OptIn(kotlin.ExperimentalStdlibApi::class, kotlin.contracts.ExperimentalContracts::class)' $FILE
          sed -i 's/val document/val document_PROTECTED/g' $FILE
          sed -i 's/var document/var document_PROTECTED/g' $FILE
          sed -i 's/document *=/document_PROTECTED =/g' $FILE
          sed -i 's/\bdocument\b/document!!/g' $FILE
          sed -i 's/document_PROTECTED/document/g' $FILE
          GRADLE_CONFIG="plugin-nativeprocessor/platforms/android/include.gradle"
          mkdir -p $(dirname $GRADLE_CONFIG)
          echo 'android { kotlinOptions { freeCompilerArgs += ["-Xopt-in=kotlin.ExperimentalStdlibApi", "-Xopt-in=kotlin.contracts.ExperimentalContracts"] } }' >> $GRADLE_CONFIG

      - name: Install Android SDK 33
        run: |
          echo "$ANDROID_HOME/cmdline-tools/latest/bin" >> $GITHUB_PATH
          echo "$ANDROID_HOME/platform-tools" >> $GITHUB_PATH
          echo "$ANDROID_HOME/emulator" >> $GITHUB_PATH
          echo "$ANDROID_HOME/build-tools/33.0.0" >> $GITHUB_PATH
          export PATH=$ANDROID_HOME/cmdline-tools/latest/bin:$PATH
          yes | sdkmanager --licenses
          sdkmanager "platforms;android-33" "build-tools;33.0.0" "emulator" "platform-tools"

      # ----------------------------------------------------------------
      # 【禁用】License 插件钩子
      # ----------------------------------------------------------------
      - name: Disable License Report Hook
        run: |
          HOOK_FILE="node_modules/@nativescript-community/licenses/scripts/after-prepareNativeApp.js"
          echo "Disabling hook: $HOOK_FILE"
          echo "module.exports = function() { console.log('License report skipped by CI override'); };" > $HOOK_FILE

      # ----------------------------------------------------------------
      # 【降维打击】修改全局 NPM 目录下的 CLI 模板 (根治 Gradle 版本问题)
      # ----------------------------------------------------------------
      # 【终极必杀】自动修复所有插件的 AGP 8.x 兼容性问题 (Namespace + BuildConfig)
      # 【双重必杀】自动注入 Namespace + 强制升级 Java 17 (解决 JVM Target 冲突)
      # 【终极同步】全格式覆盖 Java 1.8 -> 17 + Namespace 自动注入
      - name: Final Version Sync
        run: |
          # ---------------------------------------------------------------------
          # 1. 基础清理与准备
          # ---------------------------------------------------------------------
          rm -rf platforms node_modules/package-lock.json
          
          # ---------------------------------------------------------------------
          # 2. 全面升级 Gradle/AGP (CLI + Local)
          # ---------------------------------------------------------------------
          NPM_ROOT=$(npm root -g)
          echo "Patching Global & Local Gradle..."
          # 替换全局和本地的 wrapper 为 8.5
          find "$NPM_ROOT" node_modules -name "gradle-wrapper.properties" -type f -exec sed -i 's|distributionUrl=.*|distributionUrl=https\\://services.gradle.org/distributions/gradle-8.5-bin.zip|' {} +
          # 替换全局和本地的 AGP 为 8.1.4
          find "$NPM_ROOT" node_modules -name "*.gradle" -type f -print0 | xargs -0 sed -i 's/com.android.tools.build:gradle:[0-9]\.[0-9]\.[0-9]/com.android.tools.build:gradle:8.1.4/g'

          # ---------------------------------------------------------------------
          # 3. 【核心修复】强制升级 Java 1.8 -> 17 (覆盖所有可能的写法)
          # ---------------------------------------------------------------------
          echo "Force-updating Java 1.8 to 17 in ALL files..."
          
          # 目标目录
          TARGET_DIRS="node_modules App_Resources"
          
          # 写法 A: JavaVersion.VERSION_1_8
          find $TARGET_DIRS -name "*.gradle" -type f -print0 | xargs -0 sed -i 's/JavaVersion.VERSION_1_8/JavaVersion.VERSION_17/g'
          
          # 写法 B: sourceCompatibility 1.8 (无符号/带引号)
          find $TARGET_DIRS -name "*.gradle" -type f -print0 | xargs -0 sed -i "s/sourceCompatibility 1.8/sourceCompatibility 17/g"
          find $TARGET_DIRS -name "*.gradle" -type f -print0 | xargs -0 sed -i "s/sourceCompatibility '1.8'/sourceCompatibility '17'/g"
          find $TARGET_DIRS -name "*.gradle" -type f -print0 | xargs -0 sed -i 's/sourceCompatibility "1.8"/sourceCompatibility "17"/g'
          
          # 写法 C: sourceCompatibility = 1.8 (带等号) <--- 之前漏了这个！
          find $TARGET_DIRS -name "*.gradle" -type f -print0 | xargs -0 sed -i "s/sourceCompatibility = 1.8/sourceCompatibility = 17/g"
          find $TARGET_DIRS -name "*.gradle" -type f -print0 | xargs -0 sed -i "s/sourceCompatibility = '1.8'/sourceCompatibility = '17'/g"
          find $TARGET_DIRS -name "*.gradle" -type f -print0 | xargs -0 sed -i 's/sourceCompatibility = "1.8"/sourceCompatibility = "17"/g'
          
          # 写法 D: targetCompatibility (同上)
          find $TARGET_DIRS -name "*.gradle" -type f -print0 | xargs -0 sed -i "s/targetCompatibility = 1.8/targetCompatibility = 17/g"
          find $TARGET_DIRS -name "*.gradle" -type f -print0 | xargs -0 sed -i "s/targetCompatibility 1.8/targetCompatibility 17/g"
          find $TARGET_DIRS -name "*.gradle" -type f -print0 | xargs -0 sed -i "s/targetCompatibility '1.8'/targetCompatibility '17'/g"
          
          # 写法 E: Kotlin jvmTarget
          find $TARGET_DIRS -name "*.gradle" -type f -print0 | xargs -0 sed -i "s/jvmTarget = '1.8'/jvmTarget = '17'/g"
          find $TARGET_DIRS -name "*.gradle" -type f -print0 | xargs -0 sed -i 's/jvmTarget = "1.8"/jvmTarget = "17"/g'

          # ---------------------------------------------------------------------
          # 4. 自动注入 Namespace (解决 AGP 8.0 报错)
          # ---------------------------------------------------------------------
          echo "Injecting Namespaces..."
          find node_modules -name "AndroidManifest.xml" | while read manifest; do
            dir=$(dirname "$manifest")
            gradleFile="$dir/build.gradle"
            if [ -f "$gradleFile" ]; then
              pkg=$(grep -o 'package="[^"]*"' "$manifest" | cut -d'"' -f2)
              # 只有当 pkg 不为空且 gradle 文件存在时才注入
              if [ ! -z "$pkg" ]; then
                 # 简单粗暴注入：只要有 android { 就尝试注入 namespace
                 # 加上 grep 检查防止重复注入
                 if ! grep -q "namespace" "$gradleFile"; then
                    sed -i "s/android {/android { namespace '$pkg'/g" "$gradleFile"
                    # 顺手开启 buildConfig
                    sed -i "s/android {/android { buildFeatures { buildConfig = true }/g" "$gradleFile"
                 fi
              fi
            fi
          done

          # ---------------------------------------------------------------------
          # 5. 清理旧配置 (generateReleaseBuildConfig)
          # ---------------------------------------------------------------------
          find node_modules -name "*.gradle" -type f -exec sed -i '/generateReleaseBuildConfig/d' {} +
          sed -i '/generateLocaleConfig/d' "App_Resources/documentscanner/Android/app.gradle"

          # ---------------------------------------------------------------------
          # 6. 生成平台 & 再次补刀 (Double-tap)
          # ---------------------------------------------------------------------
          ns platform add android
          
          echo "Sanitizing generated platforms directory..."
          # 把生成的 platforms 目录里的 1.8 也统统改成 17
          find platforms/android -name "*.gradle" -type f -print0 | xargs -0 sed -i 's/JavaVersion.VERSION_1_8/JavaVersion.VERSION_17/g'
          find platforms/android -name "*.gradle" -type f -print0 | xargs -0 sed -i "s/sourceCompatibility = 1.8/sourceCompatibility = 17/g"
          find platforms/android -name "*.gradle" -type f -print0 | xargs -0 sed -i "s/targetCompatibility = 1.8/targetCompatibility = 17/g"
          
          # 确保 AGP 和 Gradle 正确
          find platforms/android -name "*.gradle" -type f -print0 | xargs -0 sed -i 's/com.android.tools.build:gradle:[0-9]\.[0-9]\.[0-9]/com.android.tools.build:gradle:8.1.4/g'
          find platforms/android -name "gradle-wrapper.properties" -type f -exec sed -i 's|distributionUrl=.*|distributionUrl=https\\://services.gradle.org/distributions/gradle-8.5-bin.zip|' {} +

          # ---------------------------------------------------------------------
          # 7. 编译
          # ---------------------------------------------------------------------
          keytool -genkey -v \
            -keystore debug.keystore \
            -storepass android \
            -alias androiddebugkey \
            -keypass android \
            -keyalg RSA \
            -keysize 2048 \
            -validity 10000 \
            -dname "CN=Android Debug,O=Android,C=US"

          ns build android --release \
            --no-hmr \
            --env.abiFilters=arm64-v8a \
            --force \
            --key-store-path debug.keystore \
            --key-store-password android \
            --key-store-alias androiddebugkey \
            --key-store-alias-password android
          
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: app-release
          path: platforms/android/app/build/outputs/apk/release/*.apk
          
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: app-release
          path: platforms/android/app/build/outputs/apk/release/*.apk
          
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: app-release
          path: platforms/android/app/build/outputs/apk/release/*.apk
          
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: app-release
          path: platforms/android/app/build/outputs/apk/release/*.apk
